
<div
  class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50"
  *ngIf="isModalOpen"
>
  <div class="bg-white rounded-lg shadow-lg w-full max-w-[750px] max-h-[90vh] flex flex-col">
    
    <!-- Header -->
    <div class="sticky top-0 flex justify-between items-center px-6 py-4 bg-blue-500 rounded-t">
      <h3 class="text-white font-bold text-lg">Medical Certificate</h3>

      <div class="flex items-center gap-2">
        <button
          *ngIf="step === 2"
          [disabled]="show_form"
          (click)="exportP()"
          type="button"
          class="text-2xl text-white disabled:text-gray-200"
        >
          <fa-icon [icon]="faFilePdf"></fa-icon>
        </button>

        <button 
          *ngIf="step === 2"
          [disabled]="show_form" 
          printSectionId="pdf-content" 
          ngxPrint 
          [useExistingCss]="true" 
          type="button"
          class="text-2xl text-white disabled:text-gray-200"
        >
          <fa-icon [icon]="faPrint"></fa-icon>
        </button>
      </div>
    </div>

    <!-- Content -->
    <div class="p-4 overflow-y-auto flex-1">
      
      <!-- Step 1: Purpose selection -->
      <ng-container *ngIf="step === 1">
        <label for="purpose" class="block mb-2 font-semibold">Select Purpose</label>
        <select
          id="purpose"
          class="border px-3 py-2 rounded w-full"
          [(ngModel)]="selectedPurpose"
        >
          <option value="" disabled>Select...</option>
          <option value="work">Work</option>
          <option value="school">School</option>
          <option value="travel">Travel</option>
          <option value="others">Others</option>
        </select>

        <div *ngIf="selectedPurpose === 'others'" class="mt-4">
          <label for="otherPurpose" class="block mb-2 font-semibold">Please specify</label>
          <input
            id="otherPurpose"
            class="border px-3 py-2 rounded w-full"
            type="text"
            [(ngModel)]="otherPurpose"
            placeholder="Enter purpose"
          />
        </div>

        <button
          class="mt-4 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 disabled:bg-gray-400"
          [disabled]="!isPurposeValid()"
          (click)="goToStep(2)"
        >
          Next
        </button>
      </ng-container>

      <!-- Step 2: Certificate Preview -->
      <ng-container *ngIf="step === 2">
        <div *ngIf="show_form" class="flex justify-center items-center py-4">
          <fa-icon [icon]="faSpinner" [spin]="true" class="mr-2 text-blue-600 text-xl"></fa-icon>
          <span>Loading certificate data...</span>
        </div>

        <div id="pdf-content" class="relative flex flex-col items-center w-full space-y-5 overflow-y-auto flex-1">
          <ng-container *ngFor="let info of consult">
            <div class="relative scale-[0.70] mt-4 origin-top w-full bg-white px-2 py-5 overflow-hidden">

              <!-- Watermark -->
              <img
                src="./assets/img/wah_icon.png"
                alt="Watermark"
                class="absolute inset-0 m-auto w-[300px] opacity-10 pointer-events-none select-none"
              />


              <!-- Header Section with Logo -->
              <div class="grid grid-cols-[auto_1fr_auto] items-center w-full mx-auto my-2 relative z-10">
                  <!-- Column 1: Primary Logo -->
                  <div class="flex justify-center items-start">
                    <img
                      *ngIf="primaryLogoUrl"
                      [src]="primaryLogoUrl"
                      [ngStyle]="{
                        width: getFacilityLength(facilityName).width,
                        height: getFacilityLength(facilityName).height
                      }"
                      class="rounded-full object-cover"
                    />
                  </div>

                  <!-- Column 2: Facility Text -->
                  <div class="text-center mx-6">
                    <h4 class="text-base">REPUBLIC OF THE PHILIPPINES</h4>
                    <h4 class="text-base">
                      {{ info?.header_name === 'Province Of NCR, All District'
                        ? 'National Capital Region'
                        : info?.header_name }}
                    </h4>
                    <h4 class="text-base">Municipality of {{ info?.municipality_name }}</h4>
                    <h4 class="font-semibold mt-2 text-xl">{{ facilityName }}</h4>
                  </div>

                  <!-- Column 3: Secondary Logo -->
                  <div class="flex justify-center items-start">
                    <img
                      *ngIf="secondaryLogoUrl"
                      [src]="secondaryLogoUrl"
                      [ngStyle]="{
                        width: getFacilityLength(facilityName).width,
                        height: getFacilityLength(facilityName).height
                      }"
                      class="rounded-full object-cover"
                    />
                  </div>
                </div>

              <hr class="my-5 h-0.5 border-t-0 bg-neutral-200 dark:bg-white/10" />

              <h1 class="text-xl text-center font-semibold ml-10 my-2 relative z-10">MEDICAL CERTIFICATE</h1>
              <div class="text-right mb-4 relative z-10">Date: {{ dateNgayon }}</div>

              <p class="mb-4 relative z-10">

                <span class="font-semibold uppercase">To Whom It May Concern</span><br />
                This is to certify that we have on record the following data from the patient's information, to wit:
              </p>

              <!-- Patient Info Fields -->
              <div class="flex flex-col space-y-4 border-b border-gray-300 pb-6 relative z-10">
                <ng-container *ngFor="let info of consult">
                  
                  <ng-container *ngFor="let field of [
                    { label: 'Name', value: info?.patient_name },
                    { label: 'Age', value: info?.age },
                    { label: 'Sex', value: info?.gender },
                    { label: 'Civil Status', value: info?.civil_status },
                    { label: 'Address', value: info?.address },
                    { label: 'Occupation', value: info?.occupation },
                    { label: 'Date of Consultation', value: info?.consult_date }
                  ]">
                    <div class="flex gap-4 items-start">
                      <div class="w-44 font-semibold">{{ field.label }}:</div>
                      <div class="flex-1 whitespace-pre-line">{{ field.value }}</div>
                    </div>
                  </ng-container>

                  <!-- Diagnosis (after Date of Consultation) -->
                  <div class="flex gap-4 items-start">  
                    <div class="w-44 font-semibold">Diagnosis:</div>
                    <div class="flex-1 whitespace-pre-line">
                      <ng-container *ngFor="let diag of info?.final_diagnosis; let i = index">
                        {{ diag?.lib_icd10?.icd10_desc }}<span *ngIf="i < info.final_diagnosis.length - 1">; </span>
                      </ng-container>
                    </div>
                  </div>

                  <!-- Remarks -->
                  <div class="flex gap-4 items-start">
                    <div class="w-44 font-semibold">Remarks:</div>
                    <div class="flex-1 whitespace-pre-line">
                      {{ capitalizeFirst(info?.treatment_plan) }}
                    </div>
                  </div>
                </ng-container>
              </div>

              <p class="mt-10 relative z-10">
                This document is issued upon the request of the patient for
                <span class="font-semibold">{{ displayPurpose | lowercase }}</span> purposes only and is not intended for medico-legal use.
              </p>

              <!-- Physician Signature -->
              <div class="flex justify-end mt-10 text-right relative z-10">
                <div>
                  <p class="font-semibold text-center">{{ info?.physician }}, MD</p>
                  <p class="text-sm text-gray-700 text-center">Attending Physician</p>
                  <p class="text-sm text-gray-700 text-center">License No. {{ info?.physician_prc }}</p>
                </div>
              </div>

              <!-- Footer Note -->
              <div class="mt-5 pt-6 flex items-center justify-center space-x-3 text-sm italic text-gray-700 relative z-10">
                <span>*This certificate was generated using the WAHtermelon EMR</span>
                <img src="./assets/img/wah_icon.png" class="rounded-full w-9 h-9" />
              </div>

              <span class="text-gray-500 block my-1 italic">
                {{info.province === 'NCR, All District' ? 'NCR' : info.province}}-{{consultation.consult_id}}
                </span>
                
            </div>
          </ng-container>
        </div>
      </ng-container>
    </div>

    <!-- Footer -->
    <div class="flex justify-end py-4 px-5 space-x-4 rounded-b border-t">
      <button
        [disabled]="is_loading"
        type="button"
        class="px-5 py-2 bg-red-500 text-white rounded hover:bg-red-600"
        (click)="closeModal()"
      >
        Close
      </button>
    </div>

  </div>
</div>
