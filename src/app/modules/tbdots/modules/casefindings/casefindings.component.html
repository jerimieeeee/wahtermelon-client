
<div class="m-5 border border-slate-200 rounded-lg" *ngIf="show_form">
  <div class="bg-blue-500 text-white rounded-t-md py-2 pl-3 font-semibold">
    History of TB Treatment
  </div>

  <div class="m-5">
    <form [formGroup]="previousTreatmentForm" (ngSubmit)="savePreviousTreatment()" class="grid grid-cols-3 gap-x-4 w-4/5 mx-auto">
      <div class="mx-5 col-span-3 grid grid-cols-3 gap-x-4">
        <div>
          <label for="outcome_code">Treatment Outcome</label>
          <select name="outcome_code" id="outcome_code" formControlName="outcome_code" class="input">
            <option *ngFor="let outcome of treatment_outcomes" [value]="outcome.code">{{ outcome.desc }}</option>
          </select>
        </div>

        <div>
          <label for="treatment_date">Treatment Date</label>
          <input type="date" name="treatment_date" id="treatment_date" [max]="max_date" formControlName="treatment_date" class="input">
        </div>

        <div>
          <button type="submit" class="bg-blue-500 rounded text-white px-5 py-2 mt-7 text-sm">
            <fa-icon [icon]="previousTreatmentForm.value.id ? faEdit : faAdd"></fa-icon>
            {{ previousTreatmentForm.value.id ? 'Update' : 'Add' }}
          </button>

          <button *ngIf="previousTreatmentForm.value.id" type="button" (click)="clearPreviousTreatmentForm()" class="ml-3 bg-orange-500 rounded text-white px-5 py-2 mt-7 text-sm">
            <fa-icon [icon]="faXmark"></fa-icon>
            Cancel
          </button>
        </div>
      </div>
    </form>

    <div class="w-full flex justify-center">
      <table class="w-4/5 text-sm text-left mt-5 mx-10">
        <thead class="text-xs text-white uppercase bg-blue-500">
          <tr>
            <th scope="col" class="py-3 px-6">Treatment Outcome</th>
            <th scope="col" class="py-3 px-6">Treatment Date</th>
            <th scope="col" class="py-3 px-6">Action</th>
          </tr>
        </thead>
        <tbody>
          <tr class="bg-white border-b" *ngFor="let previous_treatment of previous_treatments; trackBy:identify"> <!--  -->
            <td class="py-4 px-6">
              {{  previous_treatment.outcome.desc }}
            </td>
            <td class="py-4 px-6">
              {{ previous_treatment.treatment_date | date:'MM/dd/yyyy':'Asia/Manila' }}
            </td>
            <td class="py-4 px-6">
              <fa-icon (click)="editPreviousTreatment(previous_treatment)" [icon]="faEdit" class="mx-0 my-0 text-orange-400 hover:cursor-pointer flex-none mr-2"></fa-icon>
              <fa-icon (click)="toggleModal('delete-item', previous_treatment)" [icon]="faTrashCan" class="mx-0 my-0 text-red-500 hover:cursor-pointer flex-none mr-2"></fa-icon>

              <!-- <fa-icon (click)="editPhilhealth(philhealth)" class="mx-0 my-0 text-amber-500 hover:cursor-pointer flex-none mr-2" [icon]="faPenToSquare"></fa-icon> -->
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<div class="m-5 border border-slate-200 rounded-lg" *ngIf="show_form">
  <div class="bg-blue-500 text-white rounded-t-md py-2 pl-3 font-semibold">
    Case Findings
  </div>

  <div class="mx-5 mb-5">
    <form [formGroup]="casefindingForm" (ngSubmit)="saveCaseFindings()">
      <div class="grid grid-cols-3 gap-x-4 w-full">
        <div class="col-span-3 border-b border-slate-200 w-full my-2 font-semibold text-sky-500">
          Registration Details
        </div>
        <div class="mx-5 col-span-3 grid grid-cols-3 gap-x-4">
          <div>
            <label for="source_code">Patient Source</label>
            <select name="source_code" id="source_code" formControlName="source_code" class="input">
              <option *ngFor="let source of patient_sources" [value]="source.code">{{ source.desc }}</option>
            </select>
          </div>

          <div>
            <label for="reg_group_code">Registration Group</label>
            <select name="reg_group_code" id="reg_group_code" formControlName="reg_group_code" class="input">
              <option *ngFor="let group of reg_groups" [value]="group.code">{{ group.desc }}</option>
            </select>
          </div>

          <div>
            <label for="consult_date">Consultation Date</label>
            <input type="date" name="consult_date" id="consult_date" [max]="max_date" formControlName="consult_date" class="input">
          </div>
        </div>
      </div>

      <div class="mt-1 grid grid-cols-3 gap-x-4 w-full">
        <div class="col-span-3 border-b border-slate-200 w-full my-2 pt-3 font-semibold text-sky-500">
          Screening Data
        </div>
        <div class="mx-5 col-span-3 grid grid-cols-3 gap-x-4">
          <div>
            <label for="previous_tb_treatment_code">Previous TB Treatment</label>
            <select name="previous_tb_treatment_code" id="previous_tb_treatment_code" formControlName="previous_tb_treatment_code" class="input">
              <option *ngFor="let previous_treatment of previous_tb_treatments" [value]="previous_treatment.code">{{ previous_treatment.desc }}</option>
            </select>
          </div>

          <div>
            <label for="exposetb_flag">Exposure to TB</label>
            <select name="exposetb_flag" id="exposetb_flag" formControlName="exposetb_flag" class="input">
              <option *ngFor="let answer of answers_yn" [ngValue]="answer.code === 'N' ? 0 : 1">{{ answer.desc }}</option>
            </select>
          </div>

          <div>
            <label for="drtb_flag">Presumptive DR-TB</label>
            <select name="drtb_flag" id="drtb_flag" formControlName="drtb_flag" class="input">
              <option *ngFor="let answer of answers_yn" [ngValue]="answer.code === 'N' ? 0 : 1">{{ answer.desc }}</option>
            </select>
          </div>
        </div>
      </div>

      <div class="mt-1 grid grid-cols-3 gap-x-4 w-full">
        <div class="col-span-3 border-b border-slate-200 w-full my-2 pt-3 font-semibold text-sky-500">
          Symptoms
        </div>
        <div class="col-span-3 grid grid-cols-3 gap-x-4 mx-5" formGroupName="symptom">
          <div class="col-span-1" *ngFor="let symp of symptoms">
            <input type="checkbox" [id]="symp.code" class="border border-slate-500 rounded mr-3" [formControlName]="symp.code">
            <label class="font-normal" [attr.for]="symp.code">{{ symp.desc }}</label>
          </div>
        </div>

        <div class="col-span-3 mx-5 mt-3">
          <label for="symptom_remarks">Symptoms Remarks</label>
          <input type="text" name="symptom_remarks" id="symptom_remarks" formControlName="symptom_remarks" class="input">
        </div>
      </div>

      <div class="mt-1 grid grid-cols-3 gap-x-4 w-full">
        <div class="col-span-3 border-b border-slate-200 w-full my-2 pt-3 font-semibold text-sky-500">
          Physical Exam
        </div>
        <div class="col-span-3 grid grid-cols-3 gap-x-4 mx-5" formGroupName="physical_exam">
          <div *ngFor="let pe of pes">
            <label [attr.for]="pe.code">{{ pe.desc }}</label>
            <select [id]="pe.code" [formControlName]="pe.code" class="input">
              <option *ngFor="let answer of pe_answers" [value]="answer.code">{{ answer.desc }}</option>
            </select>
          </div>
        </div>
      </div>

      <div class="mt-1 grid grid-cols-3 gap-x-4 w-full">
        <div class="col-span-3 border-b border-slate-200 w-full my-2 pt-3 font-semibold text-sky-500">
          Risk Factor
        </div>
        <div class="col-span-3 grid grid-cols-3 gap-x-4 mx-5">
          <div class="col-span-3" *ngFor="let risk of risk_factors; let i = index">
            <input type="checkbox" [id]="'risk_factor'+(i+1)" class="border border-slate-500 rounded mr-3" [formControlName]="'risk_factor'+(i+1)">
            <label class="font-normal" [attr.for]="'risk_factor'+(i+1)">{{ risk.desc }}</label>
          </div>
        </div>
      </div>

      <div class="flex justify-center mt-5" *ngIf="!selected_tb_consult || selected_tb_consult.treatment_done === 0">
        <button [disabled]="casefindingForm.invalid || is_saving" type="submit" class="btn-save mr-5 mt-4">
          <fa-icon [icon]="is_saving ? faSpinner : faSave" [spin]="is_saving ? true : false" class="mr-2"></fa-icon>
          {{ casefindingForm.value.id ? (is_saving ? 'Updating' : 'Update') : (is_saving ? 'Saving' : 'Save') }}
        </button>
      </div>
    </form>
  </div>
</div>

<app-delete-item *ngIf="modals['delete-item']"
  [delete_id]="delete_id"
  [delete_desc]="delete_desc"
  [url]="url"
  (toggleModal)="toggleModal($event)"></app-delete-item>
