<div class="flex">
  <nav class="mt-4 flex flex-row border-b border-slate-300 text-xs">
    <button (click)="switchPage(1)" class="tabs-main w-36"
      [class]="pages===1? 'tabs-main-true rounded-t-md' : 'tabs-main-false' ">
      DENTAL VISITS
    </button>
    <button *ngIf="selected_visit || (selected_visit?.facility?.code === user_facility)" (click)="switchPage(1)" class="tabs-main w-36"
      [class]="pages===2? 'tabs-main-true rounded-t-md' : 'tabs-main-false' ">
      VISIT DETAILS
    </button>
  </nav>
  <div class="ml-auto">
    <button *ngIf="selected_visit && !selected_visit?.consult_done" (click)="toggleModal('end_visit')" type="button" class="btn-end-visit ml-auto mt-5">
      <fa-icon class="mr-1" [icon]="faDoorClosed"></fa-icon>
      End Visit
    </button>
  </div>
</div>

<nav *ngIf="pages===2" class="mt-2 flex justify-between border-b border-slate-300 text-xs">
  <div class="flex flex-row">
    <button (click)="switchTab(1)" class="tabs-main px-3"
        [class]="module===1? 'tabs-main-true' : 'tabs-main-false' ">
        COMPLAINTS
    </button>
    <button (click)="switchTab(2)" class="tabs-main px-3"
        [class]="module===2? 'tabs-main-true' : 'tabs-main-false' ">
        HISTORY
    </button>
    <button (click)="switchTab(3)" class="tabs-main px-3"
        [class]="module===3? 'tabs-main-true' : 'tabs-main-false' ">
        TOOTH CONDITION & SERVICES
    </button>
    <button (click)="switchTab(4)" class="tabs-main px-3"
        [class]="module===4? 'tabs-main-true' : 'tabs-main-false' ">
        DIAGNOSIS & TREATMENT
    </button>
  </div>
</nav>

<div class="my-5 w-full border border-gray-200 shadow-md rounded-xl" *ngIf="pages === 1">
  <div *ngIf="selected_dental_consult && (selected_dental_consult?.facility_code !== user_facility)" class="text-orange-800 border border-orange-400 bg-orange-100 rounded-md p-3 mb-2 w-full">
    There is an ongoing TB treatment for this patient on another facility.
    You are not allowed to create a new treatment or view previous treatment from other facilities.
  </div>
  <div class="flex flex-col" *ngIf="fetching_history">
    <div class="w-full flex justify-center"><fa-icon [icon]="faCircleNotch" spin="true" class="pt-10"></fa-icon></div>
    <div class="w-full flex justify-center pb-10 font-semibold">Fetching history...</div>
  </div>
  <table class="w-full text-sm text-left" *ngIf="!fetching_history && patient_dental_history">
    <thead class="text-xs text-white uppercase bg-blue-500">
      <tr>
        <th scope="col" class="py-3 px-6">Consult Date</th>
        <th scope="col" class="py-3 px-6">Status</th>
        <th scope="col" class="py-3 px-6">Action</th>
      </tr>
    </thead>
    <tbody>
      <tr class="bg-white border-b" *ngFor="let item of consult_details; let i = index">
        <td *ngIf="!consult_details" colspan="3">
          <div class="text-center">
            No records to show...
          </div>
        </td>
        <td class="py-4 px-6">
          {{ item.consult_date | date: 'MM/dd/yyyy':'Asia/Manila'}}
        </td>
        <td class="py-4 px-6">
          {{ item.consult_done ? 'Done' : 'Ongoing' }}
        </td>
        <td class="py-4 px-6">
          <button *ngIf="user_facility === item.facility.code" type="button" class="rounded-md bg-blue-500 text-white py-1 px-2" (click)="switchPage(2, item, i)">
            {{ item.consult_done ? 'View' : 'Open' }}
          </button>
        </td>
      </tr>
    </tbody>
  </table>
</div>

<div class="m-3" *ngIf="pages === 2 && module === 1">
  <app-pregnant-tag *ngIf="selected_visit.patient.gender === 'F'" [consult_details]="selected_visit"
    [have_complaint]="have_complaint"
    [allowed_to_edit]="allowed_to_edit"
    (loadConsult)="loadSelectedConsult($event)"
  ></app-pregnant-tag>
  <app-complaint-history [toggle_content]="toggle_content"
    [consult_details]="selected_visit"
    [have_complaint]="have_complaint"
    [allowed_to_edit]="allowed_to_edit"
    (loadConsult)="loadSelectedConsult($event)"
  ></app-complaint-history>
  <app-consult-history [pt_group]="'dn'"></app-consult-history>
</div>

<div *ngIf="pages === 2 && module === 2">
  <app-history [selected_visit]="selected_visit"
    (loadSelectedConsult)="loadSelectedConsult($event)"
  ></app-history>

  <app-hospitalization-history [selected_visit]="selected_visit"
    (loadSelectedConsult)="loadSelectedConsult($event)"
  ></app-hospitalization-history>

  <app-surgical-history [selected_visit]="selected_visit"
    (loadSelectedConsult)="loadSelectedConsult($event)"
  ></app-surgical-history>
</div>

<div *ngIf="pages === 2 && module === 3">
  <app-condition [selected_visit]="selected_visit"
    (loadSelectedConsult)="loadSelectedConsult($event)"
  ></app-condition>

  <app-services [selected_visit]="selected_visit"
    (loadSelectedConsult)="loadSelectedConsult($event)"
  ></app-services>
</div>

<div *ngIf="pages === 2 && module === 4">
  <app-final-dx [toggle_content]="toggle_content"
    [consult_details]="selected_visit"
    [have_complaint]="have_complaint"
    [allowed_to_edit]="allowed_to_edit"
    (loadConsult)="loadSelectedConsult($event)"
  ></app-final-dx>
  <app-prescription [toggle_content]="toggle_content"
    [consult_details]="selected_visit"
    [have_complaint]="have_complaint"
    [allowed_to_edit]="allowed_to_edit"
    [user_id]="user_id"
    (loadConsult)="loadSelectedConsult($event)"
  ></app-prescription>
</div>

<app-end-visit *ngIf="modals['end_visit']"
  (toggleModal)="toggleModal($event)"
  [consult_id]="selected_visit?.id"
  [consult_date]="selected_visit?.consult_date"
  [patient_id]="selected_visit?.patient.id"
  [pt_group]="'tb'"
></app-end-visit>
