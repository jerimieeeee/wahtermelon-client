<div class="block shadow p-4 mt-4 rounded-xl text-gray-600 border border-slate-100">
  <span class="text-sky-500 font-bold flex justify-between py-2">
    <span class="flex">
      <span class="mt-2"> Prescription and Dispensing</span>
    </span>

    <button *ngIf="consult_details?.consult_done === false" type="button" class="btn-end-visit ml-auto" (click)="toggleModal('end_visit')">
      <fa-icon class="mr-1" [icon]="faDoorClosed"></fa-icon>
      End Visit
    </button>
  </span>

  <div class="border border-slate-200 shadow-md rounded-xl">
    <div class="flex justify-between w-full bg-orange-500 text-white rounded-t-xl px-3 py-1 font-semibold text-sm">
      <span class="mt-3">Prescriptions</span>
      <div class="flex w-5/12 justify-end">
        <label for="dispensing_date" class="mr-2 mt-3">Dispense date</label>
        <input type="date" name="dispensing_date" [(ngModel)]="dispensing_date" placeholder="mm/dd/yyyy" class="input w-1/2 text-gray-700 font-normal" />
      </div>
    </div>

    <div class="w-full p-5">
      <table class="w-full text-sm text-left text-gray-500 dark:text-gray-400" *ngIf="show_form">
        <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
          <tr>
            <th scope="col" class="text-center py-3 px-3 w-3/12">Medicine</th>
            <th scope="col" class="text-center py-3 px-3 w-3/12">Intake</th>
            <th scope="col" class="text-center py-3 px-3 w-1/12">Prescription Date</th>
            <th scope="col" class="text-center py-3 px-3 w-1/12">Quantity</th>
            <th scope="col" class="text-center py-3 px-3 w-1/12">Unit of Measurement</th>
            <th scope="col" class="text-center py-3 px-3 w-1/12">Dispense Quantity</th>
            <th scope="col" class="text-center py-3 px-3 w-2/12">Remarks</th>
          </tr>
        </thead>
        <tbody *ngIf="pres_length > 0">
          <tr *ngFor="let pres of prescriptions; trackBy:identify" class="bg-white border-b last:border-0">
            <td class="py-4 px-3 font-medium">
              {{ pres.konsulta_medicine ? pres.konsulta_medicine.desc : pres.added_medicine}}
            </td>
            <td scope="row" class="py-4 px-3  text-gray-900">
              {{ pres.dosage_quantity }} {{ pres.unit_of_measurement.desc }} {{ pres.regimen.desc }}
              {{ pres.duration_intake }} {{ pres.frequency.desc }} <br /><br />

              Instruction Qty: {{ pres.instruction_quantity }}
            </td>
            <td scope="row" class="py-4 px-3  text-gray-900">
              {{ pres.prescription_date | date : 'MM/dd/yyyy'}}
            </td>
            <td scope="row" class="py-4 px-3 text-gray-900">
              {{ pres.quantity }}
            </td>
            <td scope="row" class="py-4 px-3  text-gray-900">
              {{ pres.preparation.desc }}
            </td>
            <td scope="row" class="py-4 px-3">
              <input type="number" class="w-16 h-7 border border-slate-400 rounded" [max]="pres.quantity" [(ngModel)]="pres['dispense_quantity']" (keyup)="checkValid(pres)" />
            </td>
            <td scope="row" class="py-4 px-3">
              <textarea [disabled]="!pres.dispense_quantity || pres.dispense_quantity === 0" class="w-full border border-slate-400 rounded text-sm disabled:bg-gray-200" [(ngModel)]="pres['remarks']"></textarea>
            </td>
          </tr>
        </tbody>
        <tbody *ngIf="pres_length === 0">
          <tr>
            <td colspan="7" class="text-center italic">No records found</td>
          </tr>
        </tbody>
      </table>

      <div *ngIf="!show_form" class="w-full flex justify-center">
        <fa-icon [icon]="faCircleNotch" spin="true" class="mt-15 text-blue-500 text-2xl"></fa-icon>
      </div>
    </div>

    <div *ngIf="pres_length > 0" class="flex justify-end w-full">
      <button [disabled]="!dispensing_date" type="button" class="btn-save px-10 mr-5 mb-5 disabled:bg-gray-300" (click)="onSubmit()">
        Dispense
      </button>
    </div>
  </div>

  <div class="border border-slate-200 shadow-md rounded-xl mt-5">
    <div class="w-full bg-green-500 text-white rounded-t-xl p-3 font-semibold text-sm">
      Dispensed Drugs
    </div>

    <div class="w-full p-5">
      <table class="w-full text-sm text-left text-gray-500 dark:text-gray-400" *ngIf="show_form">
        <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
          <tr>
            <th scope="col" class="text-center py-3 px-3 w-3/12 ">Medicine</th>
            <th scope="col" class="text-center py-3 px-3 w-3/12">Intake</th>
            <th scope="col" class="text-center py-3 px-3 w-1/12">Prescription Date</th>
            <th scope="col" class="text-center py-3 px-3 w-1/12">Quantity</th>
            <th scope="col" class="text-center py-3 px-3 w-1/12">Unit of Measurement</th>
            <th scope="col" class="text-center py-3 px-3 w-1/12">Dispense Quantity</th>
            <th scope="col" class="text-center py-3 px-3 w-2/12">Remarks</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let dis of dispensed_list; trackBy:identify" class="bg-white border-b last:border-0">
            <td class="py-4 px-3">
              {{ dis.prescription.konsulta_medicine ? dis.prescription.konsulta_medicine.desc : dis.prescription.added_medicine }}
            </td>
            <td scope="row" class="py-4 px-3 text-gray-900">
              {{ dis.prescription.dosage_quantity }} {{ dis.prescription.unit_of_measurement.desc }} {{ dis.prescription.regimen.desc }}
              {{ dis.prescription.duration_intake }} {{ dis.prescription.frequency.desc }} <br /><br />

              Instruction Qty: {{ dis.prescription.instruction_quantity }}
            </td>
            <td scope="row" class="py-4 px-3 text-gray-900">
              {{ dis.prescription.prescription_date | date : 'MM/dd/yyyy'}}
            </td>
            <td scope="row" class="py-4 px-3 text-gray-900">
              {{ dis.prescription.quantity }}
            </td>
            <td scope="row" class="py-4 px-3 text-gray-900">
              {{ dis.prescription.preparation.desc }}
            </td>
            <td scope="row" class="py-4 px-3 font-semibold text-center">
              {{ dis.dispense_quantity }}
            </td>
            <td scope="row" class="py-4 px-3 font-semibold">
              {{ dis.remarks === 'NA' ? '-' : dis.remarks }}
            </td>
          </tr>
        </tbody>
      </table>

      <div *ngIf="!show_form" class="w-full flex justify-center">
        <fa-icon [icon]="faCircleNotch" spin="true" class="mt-15 text-blue-500 text-2xl"></fa-icon>
      </div>
    </div>
  </div>
</div>

<!-- <app-lab-form *ngIf="modal['add']" [selected_lab]="selected_lab" (toggleModal)="toggleModal($event)"></app-lab-form>
<app-lab-delete *ngIf="modal['delete']" [selected_lab]="selected_lab" (toggleModal)="toggleModal($event)"></app-lab-delete> -->

<app-end-visit *ngIf="modal['end_visit']" (toggleModal)="toggleModal($event)"
  [consult_id]="consult_details?.id"
  [consult_date]="consult_details?.consult_date"
  [patient_id]="consult_details?.patient.id"
  [pt_group]="'cn'"
></app-end-visit>
