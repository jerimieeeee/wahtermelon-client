<!-- medical-certificate-modal.component.html -->
<div
  class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50"
  *ngIf="isModalOpen"
>
  <div class="bg-white rounded-lg shadow-lg w-full max-w-[750px] max-h-[90vh] flex flex-col">
    <!-- Header -->
    <div class="sticky top-0 flex justify-between items-center px-6 py-4 bg-blue-500 rounded-t">
      <h3 class="text-white font-bold text-lg">Medical Certificate</h3>
      <button
        *ngIf="step === 2"
        [disabled]="show_form"
        (click)="exportP()"
        type="button"
        class="text-2xl mr-5 text-white disabled:text-gray-200"
      >
        <fa-icon [icon]="faFilePdf"></fa-icon>
      </button>
    </div>

    <!-- Content -->
    <div class="p-4 overflow-y-auto flex-1">
      <!-- Step 1 -->
      <ng-container *ngIf="step === 1">
        <label for="purpose" class="block mb-2 font-semibold">Select Purpose</label>
        <select
          id="purpose"
          class="border px-3 py-2 rounded w-full"
          [(ngModel)]="selectedPurpose"
        >
          <option value="" disabled>Select...</option>
          <option value="work">Work</option>
          <option value="school">School</option>
          <option value="travel">Travel</option>
          <option value="others">Others</option>
        </select>

        <div *ngIf="selectedPurpose === 'others'" class="mt-4">
          <label for="otherPurpose" class="block mb-2 font-semibold">Please specify</label>
          <input
            id="otherPurpose"
            class="border px-3 py-2 rounded w-full"
            type="text"
            [(ngModel)]="otherPurpose"
            placeholder="Enter purpose"
          />
        </div>

        <button
          class="mt-4 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 disabled:bg-gray-400"
          [disabled]="!isPurposeValid()"
          (click)="goToStep(2)"
        >
          Next
        </button>
      </ng-container>

      <!-- Step 2 -->
      <ng-container *ngIf="step === 2">
        <div *ngIf="show_form" class="flex justify-center py-4">
          <fa-icon [icon]="faSpinner" [spin]="true" class="mr-2 text-blue-600 text-xl"></fa-icon>
          <span>Loading certificate data...</span>
        </div>

        <div
          id="pdf-content"
          class="flex flex-col items-center w-full space-y-5 overflow-y-auto flex-1"
        >
          <ng-container *ngFor="let info of consult">
            <div class="scale-[0.75] mt-4 origin-top w-full bg-white px-2 py-5">
              <div class="relative mb-6">
                <img *ngIf="logoUrl" [src]="logoUrl" class="absolute left-0 top-0 w-auto h-32 max-h-40 object-contain" />
                <div class="text-center">
                  <h4 class="font-semibold text-lg">{{ info?.facility_name }}</h4>
                  <h4 class="text-base">
                    {{ info?.header_name === 'Province Of NCR, All District' ? 'National Capital Region' : info?.header_name }}
                  </h4>
                  <h4 class="text-base">Municipality of {{ info?.municipality_name }}</h4>
                </div>
              </div>

              <h1 class="text-xl text-center font-semibold my-2">MEDICAL CERTIFICATE</h1>
              <div class="text-right mb-4">Date: {{ dateNgayon }}</div>

              <p class="mb-4">
                <span class="font-semibold uppercase">To Whom It May Concern</span><br />
                This is to certify that we have on record the following data from the patient's information, to wit:
              </p>

              <!-- Patient Info -->
              <div class="flex flex-col space-y-4 border-b border-gray-300 pb-6">
                <ng-container *ngFor="let field of [
                  { label: 'Name', value: info?.patient_name },
                  { label: 'Age', value: info?.age },
                  { label: 'Sex', value: info?.gender },
                  { label: 'Civil Status', value: info?.civil_status },
                  { label: 'Address', value: info?.address },
                  { label: 'Occupation', value: info?.occupation },
                  { label: 'Date of Consultation', value: info?.consult_date },
                  { label: 'Diagnosis', value: info?.final_diagnosis[0]?.lib_icd10?.icd10_desc },
                  { label: 'Remarks', value: capitalizeFirst(info?.treatment_plan) }
                ]">
                  <div class="flex gap-4 items-start">
                    <div class="w-44 font-semibold">{{ field.label }}:</div>
                    <div class="flex-1 whitespace-pre-line">{{ field.value }}</div>
                  </div>
                </ng-container>
              </div>

              <p class="mt-10">
                This document is issued upon the request of the patient for
                <span class="font-semibold">{{ displayPurpose | lowercase }}</span> purposes only and is not intended for medico-legal use.
              </p>

              <div class="flex justify-end mt-16 text-right">
                <div>
                  <p class="font-semibold text-center">{{ info?.physician }}, MD</p>
                  <p class="text-sm text-gray-700 text-center">Attending Physician</p>
                  <p class="text-sm text-gray-700 text-center">License No. {{ info?.physician_prc }}</p>
                </div>
              </div>

              <div class="mt-10 pt-6 flex items-center justify-center space-x-3 text-sm italic text-gray-700">
                <span>*This certificate was generated using the WAHtermelon EMR</span>
                <img src="./assets/img/wah_icon.png" class="rounded-full w-9 h-9" />
              </div>
            </div>
          </ng-container>
        </div>
      </ng-container>
    </div>

    <!-- Footer -->
    <div class="flex justify-end py-4 px-5 space-x-4 rounded-b border-t">
      <button
        [disabled]="is_loading"
        type="button"
        class="btn-save px-5 bg-red-500 text-white rounded hover:bg-red-600"
        (click)="closeModal()"
      >
        Close
      </button>
    </div>
  </div>
</div>
